#!/usr/bin/env bash
#
# aio-context - AI Context Sharing System
# Allows AI tools to share decisions, learnings, and patterns
#
# Usage:
#   aio-context decision <message>    - Log an architectural/design decision
#   aio-context learning <message>    - Share something learned
#   aio-context warning <message>     - Warn other AIs about pitfalls
#   aio-context pattern <message>     - Document a useful pattern
#   aio-context handoff <message>     - Leave notes for next AI
#   aio-context get [category]        - Get recent context
#   aio-context export [project]      - Export context to markdown
#   aio-context prune [days]          - Remove old context entries

set -euo pipefail

AIO_DIR="${AIO_DIR:-$HOME/.ai-orchestrator}"
export PATH="$AIO_DIR/bin:$PATH"

# Add context with category
add_context() {
    local category="$1"
    local message="$2"
    local project="${3:-$(pwd)}"

    aio context add "$category" "$message" "$project"
}

# Get context, optionally filtered
get_context() {
    local category="${1:-}"
    local state=$(cat "$AIO_DIR/state.json")

    if [[ -n "$category" ]]; then
        echo "$state" | jq -r --arg cat "$category" '
            .context | map(select(.category == $cat)) |
            sort_by(.createdAt) | reverse | .[0:20][] |
            "[\(.createdAt | split("T")[0])] \(.source): \(.content)"
        '
    else
        aio context list
    fi
}

# Export to markdown for AI consumption
export_context() {
    local project="${1:-}"
    local state=$(cat "$AIO_DIR/state.json")
    local output=""

    output+="# AI Shared Context\n\n"
    output+="*Auto-generated by aio-context*\n\n"

    # Decisions
    output+="## Decisions\n\n"
    local decisions=$(echo "$state" | jq -r --arg proj "$project" '
        .context | map(select(.category == "decision" and (.project == $proj or .project == null or $proj == ""))) |
        sort_by(.createdAt) | reverse | .[0:10][] |
        "- **\(.source)**: \(.content)"
    ')
    output+="${decisions:-No decisions logged}\n\n"

    # Patterns
    output+="## Patterns\n\n"
    local patterns=$(echo "$state" | jq -r --arg proj "$project" '
        .context | map(select(.category == "pattern" and (.project == $proj or .project == null or $proj == ""))) |
        sort_by(.createdAt) | reverse | .[0:10][] |
        "- **\(.source)**: \(.content)"
    ')
    output+="${patterns:-No patterns logged}\n\n"

    # Warnings
    output+="## Warnings\n\n"
    local warnings=$(echo "$state" | jq -r --arg proj "$project" '
        .context | map(select(.category == "warning" and (.project == $proj or .project == null or $proj == ""))) |
        sort_by(.createdAt) | reverse | .[0:10][] |
        "- **\(.source)**: \(.content)"
    ')
    output+="${warnings:-No warnings logged}\n\n"

    # Learnings
    output+="## Learnings\n\n"
    local learnings=$(echo "$state" | jq -r --arg proj "$project" '
        .context | map(select(.category == "learning" and (.project == $proj or .project == null or $proj == ""))) |
        sort_by(.createdAt) | reverse | .[0:10][] |
        "- **\(.source)**: \(.content)"
    ')
    output+="${learnings:-No learnings logged}\n\n"

    # Handoffs
    output+="## Recent Handoffs\n\n"
    local handoffs=$(echo "$state" | jq -r --arg proj "$project" '
        .context | map(select(.category == "handoff" and (.project == $proj or .project == null or $proj == ""))) |
        sort_by(.createdAt) | reverse | .[0:5][] |
        "- **\(.source)** (\(.createdAt | split("T")[0])): \(.content)"
    ')
    output+="${handoffs:-No handoffs logged}\n\n"

    echo -e "$output"
}

# Prune old entries
prune_context() {
    local days="${1:-30}"
    local cutoff=$(date -d "$days days ago" -u +"%Y-%m-%dT%H:%M:%SZ")

    local state=$(cat "$AIO_DIR/state.json")
    local new_state=$(echo "$state" | jq --arg cutoff "$cutoff" '
        .context |= map(select(.createdAt > $cutoff))
    ')

    echo "$new_state" | jq '.' > "$AIO_DIR/state.json"
    echo "Pruned entries older than $days days"
}

# Main
main() {
    local cmd="${1:-get}"
    shift || true

    case "$cmd" in
        decision)  add_context "decision" "$*" ;;
        learning)  add_context "learning" "$*" ;;
        warning)   add_context "warning" "$*" ;;
        pattern)   add_context "pattern" "$*" ;;
        handoff)   add_context "handoff" "$*" ;;
        get)       get_context "$@" ;;
        export)    export_context "$@" ;;
        prune)     prune_context "$@" ;;
        *)
            echo "aio-context - Share context between AI tools"
            echo ""
            echo "Commands:"
            echo "  decision <msg>   - Log a decision"
            echo "  learning <msg>   - Share a learning"
            echo "  warning <msg>    - Warn about pitfalls"
            echo "  pattern <msg>    - Document a pattern"
            echo "  handoff <msg>    - Leave handoff notes"
            echo "  get [category]   - Get recent context"
            echo "  export [project] - Export to markdown"
            echo "  prune [days]     - Remove old entries"
            ;;
    esac
}

main "$@"
